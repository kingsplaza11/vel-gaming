{% extends "sa/base.html" %}
{% block title %}User Management • Admin Panel{% endblock %}

{% block content %}

<!-- Header -->
<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
        <h1 class="h3 mb-1">User Management</h1>
        <p class="text-muted mb-0">Manage all registered users</p>
    </div>
    <button id="refreshUsersBtn" class="btn btn-outline-light btn-sm d-flex align-items-center gap-2">
        <i class="fas fa-rotate"></i>
        Refresh
    </button>
</div>

<!-- Search & Stats Container -->
<div class="dashboard-card mb-4">
    <div class="row g-3">
        <!-- Search Section -->
        <div class="col-12 col-lg-8">
            <div class="search-container">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <input 
                    type="text" 
                    id="userSearch" 
                    class="search-input" 
                    placeholder="Search users by username, email, or UID..." 
                    autocomplete="off"
                >
                <div class="search-actions">
                    <button id="clearSearch" class="btn btn-sm btn-outline-light" title="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="mt-2 d-flex flex-wrap gap-2 align-items-center">
                <small class="text-muted">Search in: </small>
                <div class="search-filters">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input search-filter" type="checkbox" id="filterUsername" checked>
                        <label class="form-check-label" for="filterUsername">Username</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input search-filter" type="checkbox" id="filterEmail" checked>
                        <label class="form-check-label" for="filterEmail">Email</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input search-filter" type="checkbox" id="filterUID" checked>
                        <label class="form-check-label" for="filterUID">UID</label>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- Users Table Card -->
<div class="dashboard-card p-0">
    <div class="px-4 pt-4 pb-3 border-bottom d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <h5 class="mb-1">All Users</h5>
            <small class="text-muted"><span id="visibleCount">{{ users|length }}</span> of {{ users|length }} users</small>
        </div>
        <div class="search-results-info" id="searchResultsInfo" style="display: none;">
            <span class="badge badge-soft-primary" id="matchCount">0 matches</span>
        </div>
    </div>

    <!-- Horizontal Scroll Wrapper -->
    <div class="table-scroll-wrapper">
        <table class="table table-hover align-middle mb-0 users-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="username">
                        User <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th class="sortable" data-sort="email">
                        Email <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th class="sortable" data-sort="wallet">
                        Wallet <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th class="sortable" data-sort="joined">
                        Joined <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th class="sortable" data-sort="status">
                        Status <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                {% for u in users %}
                <tr class="user-row" 
                    data-username="{{ u.username|lower }}" 
                    data-email="{{ u.email|lower }}"
                    data-uid="{{ u.user_uid }}"
                    data-status="{{ u.is_active|yesno:'active,blocked' }}"
                    data-verified="{{ u.has_first_deposit|yesno:'true,false' }}"
                    data-wallet="{{ u.wallet|yesno:'true,false' }}"
                    data-joined="{{ u.date_joined|date:'U' }}"
                    data-balance="{{ u.total_balance|default:'0' }}">
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="avatar-circle" data-initial="{{ u.username|first|upper }}">
                                {{ u.username|first|upper }}
                            </div>
                            <div>
                                <div class="fw-semibold username">{{ u.username }}</div>
                                <small class="text-muted uid">UID: {{ u.user_uid }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="mailto:{{ u.email }}" class="text-decoration-none email">{{ u.email }}</a>
                        <div>
                            {% if u.has_first_deposit %}
                                <small class="text-success d-flex align-items-center gap-1 mt-1">
                                    <i class="fas fa-check-circle"></i>
                                    Verified
                                </small>
                            {% else %}
                                <small class="text-warning d-flex align-items-center gap-1 mt-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Unverified
                                </small>
                            {% endif %}
                        </div>
                    </td>
                    <td class="wallet-cell">
                        {% if u.wallet %}
                            <div class="fw-semibold">
                                ₦{{ u.total_balance|floatformat:2 }}
                            </div>
                            {% if u.first_deposit_amount %}
                                <small class="text-muted d-block mt-1">
                                    First deposit: ₦{{ u.first_deposit_amount|floatformat:2 }}
                                </small>
                            {% else %}
                                <small class="text-muted d-block mt-1">
                                    No first deposit
                                </small>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-soft-secondary">No Wallet</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ u.date_joined|date:"M d, Y" }}
                        <div class="text-muted small">{{ u.date_joined|timesince }} ago</div>
                    </td>
                    <td>
                        {% if u.is_active %}
                        <span class="badge badge-soft-success">Active</span>
                        {% else %}
                        <span class="badge badge-soft-danger">Blocked</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <a href="{% url 'adminpanel:admin_user_detail' u.id %}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr id="noUsersRow">
                    <td colspan="6" class="text-center py-5 text-muted">No users found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- No Results Message -->
    <div id="noResultsMessage" class="text-center py-5" style="display: none;">
        <div class="py-4">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No matching users found</h5>
            <p class="text-muted small">Try a different search term or adjust your filters</p>
        </div>
    </div>

    <!-- Mobile scroll hint -->
    <div class="mobile-scroll-hint">
        <i class="fas fa-arrow-left me-2"></i>Swipe left to see more columns
    </div>
</div>

<!-- Empty State (for when no users exist) -->
<div id="emptyState" class="dashboard-card text-center py-5" style="display: none;">
    <i class="fas fa-users fa-4x text-muted mb-4"></i>
    <h4 class="text-muted">No Users Yet</h4>
    <p class="text-muted mb-4">There are no users in the system at the moment.</p>
</div>

<style>
/* ===== Enhanced User Management Styles ===== */

/* Search Container */
.search-container {
    position: relative;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 8px 16px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
}

.search-container:focus-within {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: rgba(255, 255, 255, 0.08);
}

.search-icon {
    color: #94a3b8;
    font-size: 0.9rem;
}

.search-input {
    border: none;
    background: transparent;
    color: var(--text-color);
    flex: 1;
    padding: 8px 0;
    font-size: 0.95rem;
    outline: none;
}

.search-input::placeholder {
    color: #94a3b8;
}

.search-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Search Filters */
.search-filters {
    background: rgba(255, 255, 255, 0.05);
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
}

.search-filters .form-check-label {
    font-size: 0.85rem;
    color: #94a3b8;
}

.search-filters .form-check-input:checked {
    background-color: var(--primary);
    border-color: var(--primary);
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 10px;
    padding: 12px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.stat-item:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
}

.stat-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.stat-content h3 {
    font-size: 1.4rem;
    background: linear-gradient(135deg, var(--primary), #667eea);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Enhanced Avatar Colors */
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #fff;
    font-size: 1.1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Sortable Headers */
.sortable {
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
    position: relative;
}

.sortable:hover {
    color: var(--primary);
}

.sortable i {
    opacity: 0.5;
    transition: opacity 0.2s ease;
}

.sortable:hover i {
    opacity: 1;
}

.sortable.sorted-asc i.fa-sort {
    display: none;
}

.sortable.sorted-asc::after {
    content: "↑";
    margin-left: 4px;
    color: var(--primary);
}

.sortable.sorted-desc i.fa-sort {
    display: none;
}

.sortable.sorted-desc::after {
    content: "↓";
    margin-left: 4px;
    color: var(--primary);
}

/* Search Results Highlight */
.highlight {
    background-color: rgba(255, 193, 7, 0.15);
    padding: 2px 4px;
    border-radius: 4px;
    color: #ffc107;
}

/* Mobile Scroll Hint Enhancement */
.mobile-scroll-hint {
    display: none;
    padding: 1rem;
    font-size: 0.85rem;
    text-align: center;
    color: #94a3b8;
    border-top: 1px solid var(--border-color);
    background: rgba(255, 255, 255, 0.02);
}

.mobile-scroll-hint i {
    animation: bounceLeft 1.5s infinite;
}

@keyframes bounceLeft {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(-4px); }
}

/* Loading State */
.loading-row {
    opacity: 0.7;
    pointer-events: none;
}

/* Empty State */
#emptyState {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Search Results Info */
.search-results-info {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Table Scroll */
.table-scroll-wrapper {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.users-table {
    min-width: 900px;
}

/* Responsive Design */
@media (max-width: 992px) {
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .search-container {
        padding: 6px 12px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .stat-item {
        padding: 10px;
    }
    
    .users-table {
        min-width: 1000px;
    }
    
    .mobile-scroll-hint {
        display: block;
    }
    
    .search-filters {
        flex-wrap: wrap;
        gap: 4px;
    }
}

@media (max-width: 576px) {
    .search-filters {
        padding: 4px 8px;
    }
    
    .search-filters .form-check-label {
        font-size: 0.8rem;
    }
}
</style>

<script>
// Color generation function for avatars
function getColorFromString(str) {
    if (!str) return 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const colors = [
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        'linear-gradient(135deg, #5ee7df 0%, #b490ca 100%)'
    ];
    
    return colors[Math.abs(hash) % colors.length];
}

// Apply colors to avatars
function applyAvatarColors() {
    document.querySelectorAll('.avatar-circle').forEach(avatar => {
        const initial = avatar.getAttribute('data-initial') || avatar.textContent.trim();
        if (initial) {
            avatar.style.background = getColorFromString(initial);
        }
    });
}

// User data cache
let userData = [];

// Initialize user data from table
function initializeUserData() {
    const rows = document.querySelectorAll('#usersTableBody .user-row');
    userData = Array.from(rows).map(row => ({
        element: row,
        username: row.dataset.username,
        email: row.dataset.email,
        uid: row.dataset.uid,
        status: row.dataset.status,
        verified: row.dataset.verified === 'true',
        hasWallet: row.dataset.wallet === 'true',
        joined: parseInt(row.dataset.joined),
        balance: parseFloat(row.dataset.balance)
    }));
}

// Search functionality
function performSearch() {
    const searchInput = document.getElementById('userSearch');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const searchUsername = document.getElementById('filterUsername').checked;
    const searchEmail = document.getElementById('filterEmail').checked;
    const searchUID = document.getElementById('filterUID').checked;
    
    const noResultsMessage = document.getElementById('noResultsMessage');
    const noUsersRow = document.getElementById('noUsersRow');
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const matchCount = document.getElementById('matchCount');
    const visibleCount = document.getElementById('visibleCount');
    
    let matchCountValue = 0;
    
    if (userData.length === 0) initializeUserData();
    
    userData.forEach(user => {
        const { element, username, email, uid } = user;
        let matches = false;
        
        if (searchTerm) {
            if (searchUsername && username.includes(searchTerm)) matches = true;
            if (searchEmail && email.includes(searchTerm)) matches = true;
            if (searchUID && uid.includes(searchTerm)) matches = true;
        } else {
            matches = true;
        }
        
        if (matches) {
            element.style.display = '';
            matchCountValue++;
            
            // Highlight matching text
            if (searchTerm) {
                highlightText(element, searchTerm);
            } else {
                removeHighlights(element);
            }
        } else {
            element.style.display = 'none';
            removeHighlights(element);
        }
    });
    
    // Update UI based on results
    visibleCount.textContent = matchCountValue;
    
    if (searchTerm) {
        if (matchCountValue === 0) {
            noResultsMessage.style.display = 'block';
            if (noUsersRow) noUsersRow.style.display = 'none';
        } else {
            noResultsMessage.style.display = 'none';
            if (noUsersRow) noUsersRow.style.display = 'none';
        }
        
        searchResultsInfo.style.display = 'block';
        matchCount.textContent = `${matchCountValue} match${matchCountValue !== 1 ? 'es' : ''}`;
    } else {
        noResultsMessage.style.display = 'none';
        searchResultsInfo.style.display = 'none';
        if (noUsersRow && userData.length === 0) {
            noUsersRow.style.display = '';
        }
    }
    
    updateUserCounts();
}

// Highlight matching text
function highlightText(element, searchTerm) {
    const textElements = element.querySelectorAll('.username, .email, .uid');
    
    textElements.forEach(el => {
        const text = el.textContent;
        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        const highlighted = text.replace(regex, '<span class="highlight">$1</span>');
        if (highlighted !== text) {
            el.innerHTML = highlighted;
        }
    });
}

// Remove highlights
function removeHighlights(element) {
    const highlights = element.querySelectorAll('.highlight');
    highlights.forEach(highlight => {
        const parent = highlight.parentNode;
        parent.textContent = parent.textContent;
    });
}

// Sort functionality
let currentSort = { column: null, direction: 'asc' };

function sortTable(column) {
    const tbody = document.getElementById('usersTableBody');
    const rows = Array.from(tbody.querySelectorAll('.user-row'));
    const sortableHeaders = document.querySelectorAll('.sortable');
    
    // Update sort headers
    sortableHeaders.forEach(header => {
        header.classList.remove('sorted-asc', 'sorted-desc');
        if (header.dataset.sort === column) {
            header.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
    
    // Sort rows
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (column) {
            case 'username':
                aValue = a.dataset.username;
                bValue = b.dataset.username;
                break;
            case 'email':
                aValue = a.dataset.email;
                bValue = b.dataset.email;
                break;
            case 'wallet':
                aValue = a.dataset.balance;
                bValue = b.dataset.balance;
                break;
            case 'joined':
                aValue = parseInt(a.dataset.joined);
                bValue = parseInt(b.dataset.joined);
                break;
            case 'status':
                aValue = a.dataset.status;
                bValue = b.dataset.status;
                break;
            default:
                return 0;
        }
        
        let comparison = 0;
        if (aValue < bValue) comparison = -1;
        if (aValue > bValue) comparison = 1;
        
        return currentSort.direction === 'asc' ? comparison : -comparison;
    });
    
    // Reappend rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update userData order
    initializeUserData();
}

// Update user counts
function updateUserCounts() {
    const visibleRows = document.querySelectorAll('#usersTableBody .user-row[style=""]');
    let verifiedCount = 0;
    let walletCount = 0;
    
    visibleRows.forEach(row => {
        if (row.dataset.verified === 'true') verifiedCount++;
        if (row.dataset.wallet === 'true') walletCount++;
    });
    
    document.getElementById('verifiedCount').textContent = verifiedCount;
    document.getElementById('walletCount').textContent = walletCount;
}

// Setup event listeners
function setupEventListeners() {
    // Search input
    const searchInput = document.getElementById('userSearch');
    const clearSearchBtn = document.getElementById('clearSearch');
    const searchFilters = document.querySelectorAll('.search-filter');
    
    // Debounced search
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    });
    
    // Clear search
    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        performSearch();
        searchInput.focus();
    });
    
    // Filter changes
    searchFilters.forEach(filter => {
        filter.addEventListener('change', performSearch);
    });
    
    // Sort headers
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.sort;
            
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            sortTable(column);
        });
    });
    
    // Refresh button
    const refreshBtn = document.getElementById('refreshUsersBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            const icon = refreshBtn.querySelector('i');
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // In a real implementation, this would fetch fresh data
                initializeUserData();
                applyAvatarColors();
                performSearch();
                updateUserCounts();
                
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
                
                // Show refresh success
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-check"></i> Refreshed';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                }, 1000);
            }, 800);
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Focus search with Ctrl/Cmd + K
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Clear search with Escape
        if (e.key === 'Escape' && document.activeElement === searchInput) {
            searchInput.value = '';
            performSearch();
        }
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    applyAvatarColors();
    initializeUserData();
    updateUserCounts();
    setupEventListeners();
    
    // Check if no users exist
    if (userData.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
    }
});
</script>

{% endblock %}